<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.29.1">
    <meta name="project" content="khepri v0.6.0">

    <title>khepri_fun â€” khepri v0.6.0</title>
    <link rel="stylesheet" href="dist/html-erlang-GK6YAAQS.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-IV5W3OL2.js"></script>
    <script src="dist/sidebar_items-40A8A753.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-XN2TSG4M.js"></script>


  </head>
  <body data-type="modules" class="page-module">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

      <a href="overview.html">
        <img src="assets/logo.svg" alt="khepri" class="sidebar-projectImage">
      </a>

    <div class="sidebar-projectDetails">
      <a href="overview.html" class="sidebar-projectName" translate="no">
khepri
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.6.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="icon-action display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


  <span translate="no">khepri_fun</span> 
  <small class="app-vsn" translate="no">(khepri v0.6.0)</small>

</h1>


  <section id="moduledoc">
<p>Anonymous function extraction private API.</p><p>This module is responsible for extracting the code of an anonymous function. The goal is to be able to store the extracted function and execute it later, regardless of the availability of the initial Erlang module which declared it.</p><p>This module also provides a way for the caller to indicate forbidden operations or function calls.</p><p>This module works on assembly code to perform all checks and prepare the storable copy of a function. It uses <code>beam_disasm:file/1</code> from the <code>compiler</code> application to extract the assembly code. After the assembly code was extracted and modified, the compiler is used again to compile the code back to an executable module.</p><p>If the anonymous function calls other functions, either in the same module or in another one, the code of the called functions is extracted and copied as well. This is to make sure the result is completely standalone.</p><p>To avoid any copies of standard Erlang APIs or Khepri itself, it is possible to specify a list of modules which should not be copied. In this case, calls to functions in those modules are left unmodified.</p><p>Once the code was extracted and verified, a new module is generated as an &quot;assembly form&quot;, ready to be compiled again to an executable module. The generated module has a single <code>run/N</code> function. This function contains the code of the extracted anonymous function.</p><p>Because this process works on the assembly code, it means that if the initial module hosting the anonymous function was compiled with Erlang version N, it will probably not compile or run on older versions of Erlang. The reason is that a newer compiler may use instructions which are unknown to older runtimes.</p><p>There is a special treatment for anonymous functions evaluated by <a href="https://www.erlang.org/doc/man/erl_eval.html"><code>erl_eval</code></a> (e.g. in the Erlang shell). &quot;erl_eval functions&quot; are lambdas parsed from text and are evaluated using <a href="https://www.erlang.org/doc/man/erl_eval.html"><code>erl_eval</code></a>.</p><p>This kind of lambdas becomes a local function in the <a href="https://www.erlang.org/doc/man/erl_eval.html"><code>erl_eval</code></a> module.</p><p>Their assembly code isn't available in the <a href="https://www.erlang.org/doc/man/erl_eval.html"><code>erl_eval</code></a> module. However, the abstract code (i.e. after parsing but before compilation) is available in the <code>env</code>. We compile that abstract code and extract the assembly from that compiled beam.</p>This module is private. The documentation is still visible because it may help understand some implementation details. However, this module should never be called directly outside of Khepri.
  </section>


  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
        <span class="sr-only">Link to this section</span>
      </a>
      Summary
    </h1>
<div class="summary-types summary">
  <h2>
    <a href="#types">Types</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:options/0" translate="no">options/0</a>

      </div>

        <div class="summary-synopsis"><p>Options to tune the extraction of an anonymous function.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:standalone_fun/0" translate="no">standalone_fun/0</a>

      </div>

        <div class="summary-synopsis"><p>The result of an extraction, as returned by <a href="#to_standalone_fun/2"><code>to_standalone_fun/2</code></a>.</p></div>

    </div>

</div>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#exec/2" translate="no">exec(StandaloneFun, Args)</a>

      </div>

        <div class="summary-synopsis"><p>Executes a previously extracted anonymous function.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#to_standalone_fun/1" translate="no">to_standalone_fun(Fun)</a>

      </div>

        <div class="summary-synopsis"><p>Extracts the given anonymous function</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#to_standalone_fun/2" translate="no">to_standalone_fun(Fun, Options)</a>

      </div>

        <div class="summary-synopsis">Extracts the given anonymous function</div>

    </div>

</div>

  </section>


  <section id="types" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#types">
        <i class="ri-link-m" aria-hidden="true"></i>
        <span class="sr-only">Link to this section</span>
      </a>
Types
    </h1>
    <div class="types-list">
<section class="detail" id="t:options/0">

  <div class="detail-header">
    <a href="#t:options/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">options/0</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-type</span> options() ::
    #{ensure_instruction_is_permitted => <a href="#t:ensure_instruction_is_permitted_fun/0">ensure_instruction_is_permitted_fun</a>(),
      should_process_function => <a href="#t:should_process_function_fun/0">should_process_function_fun</a>(),
      is_standalone_fun_still_needed => <a href="#t:is_standalone_fun_still_needed_fun/0">is_standalone_fun_still_needed_fun</a>(),
      add_module_info => boolean()}.</pre>

      </div>

<p>Options to tune the extraction of an anonymous function.</p><ul><li><code>ensure_instruction_is_permitted</code>: a function which evaluates if an instruction is permitted or not.</li><li><code>should_process_function</code>: a function which returns if a called module and function should be extracted as well or left alone.</li><li><code>is_standalone_fun_still_needed</code>: a function which returns if, after the extraction is finished, the extracted function is still needed in comparison to keeping the initial anonymous function.</li><li><code>add_module_info</code>: a boolean to indicate if the <code>module_info/0</code> and <code>module_info/1</code> functions should be added to the generated module. There are used by tracing and debugging tools in Erlang, but they take some space (about 140 bytes). Default is true.</li></ul>
  </section>
</section>
<section class="detail" id="t:standalone_fun/0">

  <div class="detail-header">
    <a href="#t:standalone_fun/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">standalone_fun/0</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-type</span> standalone_fun() :: #standalone_fun{} | fun().</pre>

      </div>

<p>The result of an extraction, as returned by <a href="#to_standalone_fun/2"><code>to_standalone_fun/2</code></a>.</p>It can be stored, passed between processes and Erlang nodes. To execute the extracted function, simply call <a href="#exec/2"><code>exec/2</code></a> which works like <a href="https://www.erlang.org/doc/man/erlang.html#apply-2"><code>erlang:apply/2</code></a>.
  </section>
</section>

    </div>
  </section>

  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
        <span class="sr-only">Link to this section</span>
      </a>
Functions
    </h1>
    <div class="functions-list">
<section class="detail" id="exec/2">

  <div class="detail-header">
    <a href="#exec/2" class="detail-link" title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">exec(StandaloneFun, Args)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-spec</span> exec(StandaloneFun, Args) -> Ret
        when StandaloneFun :: <a href="#t:standalone_fun/0">standalone_fun</a>(), Args :: [any()], Ret :: any().</pre>

      </div>

<p>Executes a previously extracted anonymous function.</p><p>This is the equivalent of <a href="https://www.erlang.org/doc/man/erlang.html#apply-2"><code>erlang:apply/2</code></a> but it supports extracted anonymous functions.</p>The list of <code>Args</code> must match the arity of the anonymous function.
  </section>
</section>
<section class="detail" id="to_standalone_fun/1">

  <div class="detail-header">
    <a href="#to_standalone_fun/1" class="detail-link" title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">to_standalone_fun(Fun)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-spec</span> to_standalone_fun(Fun) -> StandaloneFun when Fun :: fun(), StandaloneFun :: <a href="#t:standalone_fun/0">standalone_fun</a>().</pre>

      </div>

<p>Extracts the given anonymous function</p>This is the same as:<pre><code class="makeup erlang" translate="no"><span class="w">  </span><span class="nc">khepri_fun</span><span class="p">:</span><span class="nf">to_standalone_fun</span><span class="p" data-group-id="7871772540-1">(</span><span class="n">Fun</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7871772540-2">#{</span><span class="p" data-group-id="7871772540-2">}</span><span class="p" data-group-id="7871772540-1">)</span><span class="p">.</span></code></pre>
  </section>
</section>
<section class="detail" id="to_standalone_fun/2">

  <div class="detail-header">
    <a href="#to_standalone_fun/2" class="detail-link" title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">to_standalone_fun(Fun, Options)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-spec</span> to_standalone_fun(Fun, Options) -> StandaloneFun
                     when Fun :: fun(), Options :: <a href="#t:options/0">options</a>(), StandaloneFun :: <a href="#t:standalone_fun/0">standalone_fun</a>().</pre>

      </div>

Extracts the given anonymous function
  </section>
</section>

    </div>
  </section>

      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/khepri/0.6.0" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/khepri/0.6.0">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/khepri/0.6.0/show/src/khepri_fun.erl">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="khepri.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.29.1) for the

            <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
